"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.searchSetlistHandler = void 0;
const node_fetch_1 = require("node-fetch");
const aws_sdk_1 = require("aws-sdk");
const dynamodb_data_mapper_1 = require("@aws/dynamodb-data-mapper");
const dynamodb_1 = require("aws-sdk/clients/dynamodb");
const querystring_1 = require("querystring");
const { SETLIST_FM_KEY, TABLE_NAME } = process.env;
const dynamo = new aws_sdk_1.DynamoDB();
const docClient = new dynamodb_1.DocumentClient();
const client = new dynamodb_data_mapper_1.DataMapper({ client: dynamo });
const searchSetlistHandler = async (event, context) => {
    console.info("eventData: ", event);
    const { queryStringParameters } = event;
    const { artistMbid } = queryStringParameters;
    if (!SETLIST_FM_KEY) {
        throw new Error("Missing Setlist FM API Key");
    }
    const headers = new node_fetch_1.Headers({
        "x-api-key": SETLIST_FM_KEY,
        Accept: "application/json",
    });
    const searchResult = await node_fetch_1.default(`https://api.setlist.fm/rest/1.0/artist/${artistMbid}/setlists`, {
        method: "GET",
        headers,
    });
    let { setlist: setlists } = await searchResult.json();
    console.info("Setlist data: ", setlists);
    let artistName;
    const fixedSetlists = setlists.map((setlist) => {
        artistName = setlist.artist.name;
        const fullSet = setlist.sets.set.reduce((prev, { song }) => {
            return [...prev, ...song];
        }, []);
        return { ...setlist, set: fullSet };
    });
    //persist this data and try to get it at the beginning of this lambda
    //get user from db
    const userEmail = "grifhammer@gmail.com";
    console.log(`getting user for email: ${userEmail}`);
    const { access_token, expiration } = await getUser(userEmail);
    if (new Date() > new Date(expiration)) {
        return {
            statusCode: 403,
            data: "expired token",
        };
    }
    // reduce all songs to prevent double requests
    const dedupedSongs = reduceSongs(fixedSetlists);
    //get spotify data
    const spotifySongData = getAllSpotifySongData(access_token, artistName, dedupedSongs);
    const promises = Object.entries(spotifySongData);
    console.info("Promises", promises);
    await Promise.all(promises);
    const resolvedData = {};
    const data = Object.entries(spotifySongData).map(async ([artistName, promise]) => {
        console.info(artistName, await promise);
        resolvedData[artistName] = await promise;
    });
    await Promise.all(data);
    console.info(resolvedData);
    const returnBody = fixedSetlists.map(({ set, ...setlist }) => {
        console.log(set);
        return {
            ...setlist,
            set: set.map(({ name }) => {
                const thisSong = resolvedData[name].tracks.items[0];
                if (!thisSong) {
                    console.log(resolvedData[name]);
                    return { name };
                }
                console.log(thisSong);
                return {
                    spotifyUri: thisSong.uri,
                    spotifyId: thisSong.id,
                    spotifyImages: thisSong.images,
                    spotifyHref: thisSong.href,
                    name,
                };
            }),
        };
    });
    const response = {
        statusCode: 200,
        body: JSON.stringify(returnBody),
        headers: {
            "Access-Control-Allow-Origin": "*",
        },
    };
    return response;
};
exports.searchSetlistHandler = searchSetlistHandler;
function getAllSpotifySongData(accessToken, artistName, songList) {
    const spotifySongData = {};
    for (const songName in songList) {
        spotifySongData[songName] = getSpotifySong(accessToken, songName, artistName);
    }
    return spotifySongData;
}
async function getSpotifySong(accessToken, songName, artistName) {
    const queryString = querystring_1.stringify({
        q: `track:${songName} artist:${artistName}`,
        type: "track",
        market: "from_token",
        limit: 1,
    });
    const spotifyResult = await node_fetch_1.default(`https://api.spotify.com/v1/search?${queryString}`, {
        headers: {
            Authorization: `Bearer ${accessToken}`,
        },
    });
    return spotifyResult.json();
}
async function getUser(email) {
    const { Item: user } = await docClient
        .get({
        TableName: "theOneTable",
        Key: {
            pk: `u:${email}`,
            sk: `u:${email}`,
        },
    })
        .promise();
    // const user = await client.get(
    // 	Object.assign(new User(), { pk: `u:${email}`, sk: `u:${email}` })
    // );
    console.log(user);
    return {
        birthdate: "",
        email: "",
        country: "",
        product: "",
        external_urls: {
            spotify: "",
        },
        href: "",
        id: "",
        type: "user",
        uri: "",
        access_token: "",
        expiration: new Date(),
        ...user,
    };
}
function reduceSongs(setlists) {
    return setlists.reduce((prev, curr) => {
        const reducedThing = curr.set.reduce((prev, current) => {
            return {
                ...prev,
                [current.name]: current,
            };
        }, {});
        return { ...prev, ...reducedThing };
    }, {});
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0bGlzdC1zZWFyY2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXRsaXN0LXNlYXJjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFhQSwyQ0FBNEM7QUFDNUMscUNBQW1DO0FBQ25DLG9FQUF1RDtBQUN2RCx1REFBMEQ7QUFDMUQsNkNBQXdDO0FBV3hDLE1BQU0sRUFBRSxjQUFjLEVBQUUsVUFBVSxFQUFFLEdBQUcsT0FBTyxDQUFDLEdBQXVCLENBQUM7QUFFdkUsTUFBTSxNQUFNLEdBQUcsSUFBSSxrQkFBUSxFQUFFLENBQUM7QUFDOUIsTUFBTSxTQUFTLEdBQUcsSUFBSSx5QkFBYyxFQUFFLENBQUM7QUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxpQ0FBVSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDM0MsTUFBTSxvQkFBb0IsR0FBd0MsS0FBSyxFQUM3RSxLQUFLLEVBQ0wsT0FBTyxFQUNOLEVBQUU7SUFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNuQyxNQUFNLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDeEMsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUE2QixxQkFBc0IsQ0FBQztJQUN4RSxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztLQUM5QztJQUVELE1BQU0sT0FBTyxHQUFHLElBQUksb0JBQU8sQ0FBQztRQUMzQixXQUFXLEVBQUUsY0FBYztRQUMzQixNQUFNLEVBQUUsa0JBQWtCO0tBQzFCLENBQUMsQ0FBQztJQUVILE1BQU0sWUFBWSxHQUFHLE1BQU0sb0JBQUssQ0FDL0IsMENBQTBDLFVBQVUsV0FBVyxFQUMvRDtRQUNDLE1BQU0sRUFBRSxLQUFLO1FBQ2IsT0FBTztLQUNQLENBQ0QsQ0FBQztJQUNGLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxF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SSxFQUFFLEVBQUU7UUFDOUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQ25DLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ2pCLE9BQU87Z0JBQ04sR0FBRyxJQUFJO2dCQUNQLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU87YUFDdkIsQ0FBQztRQUNILENBQUMsRUFDRCxFQUFFLENBQ0YsQ0FBQztRQUNGLE9BQU8sRUFBRSxHQUFHLElBQUksRUFBRSxHQUFHLFlBQVksRUFBRSxDQUFDO0lBQ3JDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNSLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHRBUElHYXRld2F5UHJveHlIYW5kbGVyVjIsXG5cdEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyLFxuXHRBUElHYXRld2F5UHJveHlFdmVudFF1ZXJ5U3RyaW5nUGFyYW1ldGVycyxcbn0gZnJvbSBcImF3cy1sYW1iZGFcIjtcbmltcG9ydCB7XG5cdEFydGlzdCxcblx0U2V0bGlzdFNlYXJjaCxcblx0U29uZyxcblx0VG91cixcblx0VmVudWUsXG59IGZyb20gXCIuLi8uLi90eXBlcy9zZXRsaXN0LWZtXCI7XG5pbXBvcnQgeyBTZXRsaXN0IH0gZnJvbSBcIi4uLy4uL3R5cGVzL3NldGxpc3QtZm1cIjtcbmltcG9ydCBmZXRjaCwgeyBIZWFkZXJzIH0gZnJvbSBcIm5vZGUtZmV0Y2hcIjtcbmltcG9ydCB7IER5bmFtb0RCIH0gZnJvbSBcImF3cy1zZGtcIjtcbmltcG9ydCB7IERhdGFNYXBwZXIgfSBmcm9tIFwiQGF3cy9keW5hbW9kYi1kYXRhLW1hcHBlclwiO1xuaW1wb3J0IHsgRG9jdW1lbnRDbGllbnQgfSBmcm9tIFwiYXdzLXNkay9jbGllbnRzL2R5bmFtb2RiXCI7XG5pbXBvcnQgeyBzdHJpbmdpZnkgfSBmcm9tIFwicXVlcnlzdHJpbmdcIjtcbmltcG9ydCB7IGFjY2VzcyB9IGZyb20gXCJub2RlOmZzXCI7XG5cbmludGVyZmFjZSBTZWFyY2hTZXRsaXN0RW52IGV4dGVuZHMgTm9kZUpTLlByb2Nlc3NFbnYge1xuXHRTRVRMSVNUX0ZNX0tFWTogc3RyaW5nO1xuXHRUQUJMRV9OQU1FOiBzdHJpbmc7XG59XG5pbnRlcmZhY2UgU2VhcmNoU2V0bGlzdFJlcXVlc3RCb2R5XG5cdGV4dGVuZHMgQVBJR2F0ZXdheVByb3h5RXZlbnRRdWVyeVN0cmluZ1BhcmFtZXRlcnMge1xuXHRhcnRpc3RNYmlkPzogc3RyaW5nO1xufVxuY29uc3QgeyBTRVRMSVNUX0ZNX0tFWSwgVEFCTEVfTkFNRSB9ID0gcHJvY2Vzcy5lbnYgYXMgU2VhcmNoU2V0bGlzdEVudjtcblxuY29uc3QgZHluYW1vID0gbmV3IER5bmFtb0RCKCk7XG5jb25zdCBkb2NDbGllbnQgPSBuZXcgRG9jdW1lbnRDbGllbnQoKTtcbmNvbnN0IGNsaWVudCA9IG5ldyBEYXRhTWFwcGVyKHsgY2xpZW50OiBkeW5hbW8gfSk7XG5leHBvcnQgY29uc3Qgc2VhcmNoU2V0bGlzdEhhbmRsZXI6IEFQSUdhdGV3YXlQcm94eUhhbmRsZXJWMjxbU2V0bGlzdF0+ID0gYXN5bmMgKFxuXHRldmVudCxcblx0Y29udGV4dFxuKSA9PiB7XG5cdGNvbnNvbGUuaW5mbyhcImV2ZW50RGF0YTogXCIsIGV2ZW50KTtcblx0Y29uc3QgeyBxdWVyeVN0cmluZ1BhcmFtZXRlcnMgfSA9IGV2ZW50O1xuXHRjb25zdCB7IGFydGlzdE1iaWQgfTogU2VhcmNoU2V0bGlzdFJlcXVlc3RCb2R5ID0gcXVlcnlTdHJpbmdQYXJhbWV0ZXJzITtcblx0aWYgKCFTRVRMSVNUX0ZNX0tFWSkge1xuXHRcdHRocm93IG5ldyBFcnJvcihcIk1pc3NpbmcgU2V0bGlzdCBGTSBBUEkgS2V5XCIpO1xuXHR9XG5cblx0Y29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHtcblx0XHRcIngtYXBpLWtleVwiOiBTRVRMSVNUX0ZNX0tFWSxcblx0XHRBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuXHR9KTtcblxuXHRjb25zdCBzZWFyY2hSZXN1bHQgPSBhd2FpdCBmZXRjaChcblx0XHRgaHR0cHM6Ly9hcGkuc2V0bGlzdC5mbS9yZXN0LzEuMC9hcnRpc3QvJHthcnRpc3RNYmlkfS9zZXRsaXN0c2AsXG5cdFx0e1xuXHRcdFx0bWV0aG9kOiBcIkdFVFwiLFxuXHRcdFx0aGVhZGVycyxcblx0XHR9XG5cdCk7XG5cdGxldCB7IHNldGxpc3Q6IHNldGxpc3RzIH06IFNldGxpc3RTZWFyY2ggPSBhd2FpdCBzZWFyY2hSZXN1bHQuanNvbigpO1xuXG5cdGNvbnNvbGUuaW5mbyhcIlNldGxpc3QgZGF0YTogXCIsIHNldGxpc3RzKTtcblx0bGV0IGFydGlzdE5hbWU6IHN0cmluZztcblx0Y29uc3QgZml4ZWRTZXRsaXN0cyA9IHNldGxpc3RzLm1hcCgoc2V0bGlzdCkgPT4ge1xuXHRcdGFydGlzdE5hbWUgPSBzZXRsaXN0LmFydGlzdC5uYW1lO1xuXHRcdGNvbnN0IGZ1bGxTZXQgPSBzZXRsaXN0LnNldHMuc2V0LnJlZHVjZTxTb25nW10+KChwcmV2LCB7IHNvbmcgfSkgPT4ge1xuXHRcdFx0cmV0dXJuIFsuLi5wcmV2LCAuLi5zb25nXTtcblx0XHR9LCBbXSk7XG5cdFx0cmV0dXJuIHsgLi4uc2V0bGlzdCwgc2V0OiBmdWxsU2V0IH07XG5cdH0pO1xuXHQvL3BlcnNpc3QgdGhpcyBkYXRhIGFuZCB0cnkgdG8gZ2V0IGl0IGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhpcyBsYW1iZGFcblx0Ly9nZXQgdXNlciBmcm9tIGRiXG5cdGNvbnN0IHVzZXJFbWFpbCA9IFwiZ3JpZmhhbW1lckBnbWFpbC5jb21cIjtcblx0Y29uc29sZS5sb2coYGdldHRpbmcgdXNlciBmb3IgZW1haWw6ICR7dXNlckVtYWlsfWApO1xuXHRjb25zdCB7IGFjY2Vzc190b2tlbiwgZXhwaXJhdGlvbiB9ID0gYXdhaXQgZ2V0VXNlcih1c2VyRW1haWwpO1xuXHRpZiAobmV3IERhdGUoKSA+IG5ldyBEYXRlKGV4cGlyYXRpb24pKSB7XG5cdFx0cmV0dXJuIHtcblx0XHRcdHN0YXR1c0NvZGU6IDQwMyxcblx0XHRcdGRhdGE6IFwiZXhwaXJlZCB0b2tlblwiLFxuXHRcdH07XG5cdH1cblx0Ly8gcmVkdWNlIGFsbCBzb25ncyB0byBwcmV2ZW50IGRvdWJsZSByZXF1ZXN0c1xuXHRjb25zdCBkZWR1cGVkU29uZ3MgPSByZWR1Y2VTb25ncyhmaXhlZFNldGxpc3RzKTtcblx0Ly9nZXQgc3BvdGlmeSBkYXRhXG5cdGNvbnN0IHNwb3RpZnlTb25nRGF0YSA9IGdldEFsbFNwb3RpZnlTb25nRGF0YShcblx0XHRhY2Nlc3NfdG9rZW4sXG5cdFx0YXJ0aXN0TmFtZSEsXG5cdFx0ZGVkdXBlZFNvbmdzXG5cdCk7XG5cdGNvbnN0IHByb21pc2VzID0gT2JqZWN0LmVudHJpZXMoc3BvdGlmeVNvbmdEYXRhKTtcblx0Y29uc29sZS5pbmZvKFwiUHJvbWlzZXNcIiwgcHJvbWlzZXMpO1xuXHRhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XG5cdGNvbnN0IHJlc29sdmVkRGF0YTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuXHRjb25zdCBkYXRhID0gT2JqZWN0LmVudHJpZXMoc3BvdGlmeVNvbmdEYXRhKS5tYXAoXG5cdFx0YXN5bmMgKFthcnRpc3ROYW1lLCBwcm9taXNlXSkgPT4ge1xuXHRcdFx0Y29uc29sZS5pbmZvKGFydGlzdE5hbWUsIGF3YWl0IHByb21pc2UpO1xuXHRcdFx0cmVzb2x2ZWREYXRhW2FydGlzdE5hbWVdID0gYXdhaXQgcHJvbWlzZTtcblx0XHR9XG5cdCk7XG5cdGF3YWl0IFByb21pc2UuYWxsKGRhdGEpO1xuXHRjb25zb2xlLmluZm8ocmVzb2x2ZWREYXRhKTtcblx0Y29uc3QgcmV0dXJuQm9keSA9IGZpeGVkU2V0bGlzdHMubWFwKCh7IHNldCwgLi4uc2V0bGlzdCB9KSA9PiB7XG5cdFx0Y29uc29sZS5sb2coc2V0KTtcblx0XHRyZXR1cm4ge1xuXHRcdFx0Li4uc2V0bGlzdCxcblx0XHRcdHNldDogc2V0Lm1hcCgoeyBuYW1lIH0pID0+IHtcblx0XHRcdFx0Y29uc3QgdGhpc1NvbmcgPSByZXNvbHZlZERhdGFbbmFtZV0udHJhY2tzLml0ZW1zWzBdO1xuXHRcdFx0XHRpZiAoIXRoaXNTb25nKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2cocmVzb2x2ZWREYXRhW25hbWVdKTtcblx0XHRcdFx0XHRyZXR1cm4geyBuYW1lIH07XG5cdFx0XHRcdH1cblx0XHRcdFx0Y29uc29sZS5sb2codGhpc1NvbmcpO1xuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdHNwb3RpZnlVcmk6IHRoaXNTb25nLnVyaSxcblx0XHRcdFx0XHRzcG90aWZ5SWQ6IHRoaXNTb25nLmlkLFxuXHRcdFx0XHRcdHNwb3RpZnlJbWFnZXM6IHRoaXNTb25nLmltYWdlcyxcblx0XHRcdFx0XHRzcG90aWZ5SHJlZjogdGhpc1NvbmcuaHJlZixcblx0XHRcdFx0XHRuYW1lLFxuXHRcdFx0XHR9O1xuXHRcdFx0fSksXG5cdFx0fTtcblx0fSk7XG5cdGNvbnN0IHJlc3BvbnNlOiBBUElHYXRld2F5UHJveHlSZXN1bHRWMiA9IHtcblx0XHRzdGF0dXNDb2RlOiAyMDAsXG5cdFx0Ym9keTogSlNPTi5zdHJpbmdpZnkocmV0dXJuQm9keSksXG5cdFx0aGVhZGVyczoge1xuXHRcdFx0XCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIjogXCIqXCIsXG5cdFx0fSxcblx0fTtcblx0cmV0dXJuIHJlc3BvbnNlO1xufTtcbmZ1bmN0aW9uIGdldEFsbFNwb3RpZnlTb25nRGF0YShcblx0YWNjZXNzVG9rZW46IHN0cmluZyxcblx0YXJ0aXN0TmFtZTogc3RyaW5nLFxuXHRzb25nTGlzdDogeyBba2V5OiBzdHJpbmddOiBTb25nIH1cbik6IHsgW2tleTogc3RyaW5nXTogUHJvbWlzZTxhbnk+IH0ge1xuXHRjb25zdCBzcG90aWZ5U29uZ0RhdGE6IHsgW2tleTogc3RyaW5nXTogUHJvbWlzZTxhbnk+IH0gPSB7fTtcblx0Zm9yIChjb25zdCBzb25nTmFtZSBpbiBzb25nTGlzdCkge1xuXHRcdHNwb3RpZnlTb25nRGF0YVtzb25nTmFtZV0gPSBnZXRTcG90aWZ5U29uZyhcblx0XHRcdGFjY2Vzc1Rva2VuLFxuXHRcdFx0c29uZ05hbWUsXG5cdFx0XHRhcnRpc3ROYW1lIVxuXHRcdCk7XG5cdH1cblx0cmV0dXJuIHNwb3RpZnlTb25nRGF0YTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U3BvdGlmeVNvbmcoXG5cdGFjY2Vzc1Rva2VuOiBzdHJpbmcsXG5cdHNvbmdOYW1lOiBzdHJpbmcsXG5cdGFydGlzdE5hbWU6IHN0cmluZ1xuKSB7XG5cdGNvbnN0IHF1ZXJ5U3RyaW5nID0gc3RyaW5naWZ5KHtcblx0XHRxOiBgdHJhY2s6JHtzb25nTmFtZX0gYXJ0aXN0OiR7YXJ0aXN0TmFtZX1gLFxuXHRcdHR5cGU6IFwidHJhY2tcIixcblx0XHRtYXJrZXQ6IFwiZnJvbV90b2tlblwiLFxuXHRcdGxpbWl0OiAxLFxuXHR9KTtcblx0Y29uc3Qgc3BvdGlmeVJlc3VsdCA9IGF3YWl0IGZldGNoKFxuXHRcdGBodHRwczovL2FwaS5zcG90aWZ5LmNvbS92MS9zZWFyY2g/JHtxdWVyeVN0cmluZ31gLFxuXHRcdHtcblx0XHRcdGhlYWRlcnM6IHtcblx0XHRcdFx0QXV0aG9yaXphdGlvbjogYEJlYXJlciAke2FjY2Vzc1Rva2VufWAsXG5cdFx0XHR9LFxuXHRcdH1cblx0KTtcblx0cmV0dXJuIHNwb3RpZnlSZXN1bHQuanNvbigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRVc2VyKFxuXHRlbWFpbDogc3RyaW5nXG4pOiBQcm9taXNlPFxuXHRTcG90aWZ5QXBpLlVzZXJPYmplY3RQcml2YXRlICZcblx0XHRTcG90aWZ5QXBpLlVzZXJPYmplY3RQdWJsaWMgJiB7IGFjY2Vzc190b2tlbjogc3RyaW5nOyBleHBpcmF0aW9uOiBEYXRlIH1cbj4ge1xuXHRjb25zdCB7IEl0ZW06IHVzZXIgfSA9IGF3YWl0IGRvY0NsaWVudFxuXHRcdC5nZXQoe1xuXHRcdFx0VGFibGVOYW1lOiBcInRoZU9uZVRhYmxlXCIsXG5cdFx0XHRLZXk6IHtcblx0XHRcdFx0cGs6IGB1OiR7ZW1haWx9YCxcblx0XHRcdFx0c2s6IGB1OiR7ZW1haWx9YCxcblx0XHRcdH0sXG5cdFx0fSlcblx0XHQucHJvbWlzZSgpO1xuXHQvLyBjb25zdCB1c2VyID0gYXdhaXQgY2xpZW50LmdldChcblx0Ly8gXHRPYmplY3QuYXNzaWduKG5ldyBVc2VyKCksIHsgcGs6IGB1OiR7ZW1haWx9YCwgc2s6IGB1OiR7ZW1haWx9YCB9KVxuXHQvLyApO1xuXHRjb25zb2xlLmxvZyh1c2VyKTtcblx0cmV0dXJuIHtcblx0XHRiaXJ0aGRhdGU6IFwiXCIsXG5cdFx0ZW1haWw6IFwiXCIsXG5cdFx0Y291bnRyeTogXCJcIixcblx0XHRwcm9kdWN0OiBcIlwiLFxuXHRcdGV4dGVybmFsX3VybHM6IHtcblx0XHRcdHNwb3RpZnk6IFwiXCIsXG5cdFx0fSxcblx0XHRocmVmOiBcIlwiLFxuXHRcdGlkOiBcIlwiLFxuXHRcdHR5cGU6IFwidXNlclwiLFxuXHRcdHVyaTogXCJcIixcblx0XHRhY2Nlc3NfdG9rZW46IFwiXCIsXG5cdFx0ZXhwaXJhdGlvbjogbmV3IERhdGUoKSxcblx0XHQuLi51c2VyLFxuXHR9O1xufVxuXG5mdW5jdGlvbiByZWR1Y2VTb25ncyhcblx0c2V0bGlzdHM6IHtcblx0XHRzZXQ6IFNvbmdbXTtcblx0XHRhcnRpc3Q6IEFydGlzdDtcblx0XHR2ZW51ZTogVmVudWU7XG5cdFx0dG91cjogVG91cjtcblx0XHRpbmZvOiBzdHJpbmc7XG5cdFx0dXJsOiBzdHJpbmc7XG5cdFx0aWQ6IHN0cmluZztcblx0XHR2ZXJzaW9uSWQ6IHN0cmluZztcblx0XHRsYXN0Rm1FdmVudElkOiBudW1iZXI7XG5cdFx0ZXZlbnREYXRlOiBzdHJpbmc7XG5cdFx0bGFzdFVwZGF0ZWQ6IHN0cmluZztcblx0fVtdXG4pOiB7IFtrZXk6IHN0cmluZ106IFNvbmcgfSB7XG5cdHJldHVybiBzZXRsaXN0cy5yZWR1Y2U8eyBba2V5OiBzdHJpbmddOiBTb25nIH0+KChwcmV2LCBjdXJyKSA9PiB7XG5cdFx0Y29uc3QgcmVkdWNlZFRoaW5nID0gY3Vyci5zZXQucmVkdWNlPHsgW2tleTogc3RyaW5nXTogU29uZyB9Pihcblx0XHRcdChwcmV2LCBjdXJyZW50KSA9PiB7XG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0Li4ucHJldixcblx0XHRcdFx0XHRbY3VycmVudC5uYW1lXTogY3VycmVudCxcblx0XHRcdFx0fTtcblx0XHRcdH0sXG5cdFx0XHR7fVxuXHRcdCk7XG5cdFx0cmV0dXJuIHsgLi4ucHJldiwgLi4ucmVkdWNlZFRoaW5nIH07XG5cdH0sIHt9KTtcbn1cbiJdfQ==